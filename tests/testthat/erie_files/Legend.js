// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(u,y){var l;return function(){l&&clearTimeout(l);var f=this,p=arguments;l=setTimeout(function(){u.apply(f,p)},y)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(u,y,l,f){var p=function(f,k){return f-k},x={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(f){var k=String(f),h=k.match(x._reNumber);f={integer:0,fractional:0};h&&h[1]?(f.integer=h[1].split("").length,
f.fractional=h[3]?h[3].split("").length:0):-1<k.toLowerCase().indexOf("e")&&(h=k.split("e"),k=h[0],h=h[1],k&&h&&(k=Number(k),h=Number(h),(f=0<h)||(h=Math.abs(h)),k=x.getDigits(k),f?(k.integer+=h,k.fractional=h>k.fractional?0:k.fractional-h):(k.fractional+=h,k.integer=h>k.integer?1:k.integer-h),f=k));return f},getFixedNumbers:function(f,k){var h;h=Number(f.toFixed(k));h<f?f=h+1/Math.pow(10,k):(f=h,h-=1/Math.pow(10,k));h=Number(h.toFixed(k));f=Number(f.toFixed(k));return[h,f]},getPctChange:function(f,
k,h,l){var B={prev:null,next:null},p;null!=h&&(p=f-h,B.prev=Math.floor(Math.abs(100*(k-h-p)/p)));null!=l&&(p=l-f,B.next=Math.floor(Math.abs(100*(l-k-p)/p)));return B},round:function(f,k){f=f.slice(0);var h,l,B,u,y,A,d,z,r=k&&null!=k.tolerance?k.tolerance:2,v=k&&k.indexes,R=k&&null!=k.strictBounds?k.strictBounds:!1;if(v)v.sort(p);else for(v=[],y=0;y<f.length;y++)v.push(y);for(y=0;y<v.length;y++)if(z=v[y],k=f[z],h=0===z?null:f[z-1],l=z===f.length-1?null:f[z+1],B=x.getDigits(k),B=B.fractional){A=0;for(d=
!1;A<=B&&!d;)u=x.getFixedNumbers(k,A),u=R&&0===y?u[1]:u[0],d=x.hasMinimalChange(k,u,h,l,r),A++;d&&(f[z]=u)}return f},hasMinimalChange:function(f,l,h,p,u){f=x.getPctChange(f,l,h,p);l=null==f.prev||f.prev<=u;h=null==f.next||f.next<=u;return l&&h||f.prev+f.next<=2*u},_reAllZeros:new RegExp("\\"+l.decimal+"0+$","g"),_reSomeZeros:/(\d)0*$/g,format:function(f,l){l=l||{places:20,round:-1};(f=y.format(f,l))&&(f=f.replace(x._reSomeZeros,"$1").replace(x._reAllZeros,""));return f}};u("extend-esri")&&(f.numberUtils=
x);return x})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(u,y,l,f,p,x,B,k){function h(d){return d&&y.map(d,function(d){return new B(d)})}function U(d,f,l){var v="";0===f?v=H.lt+" ":f===l&&(v=H.gt+" ");return v+d}var E={},H={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},Q={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},A={millisecond:{dateOptions:{formatLength:"long"},
timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},d={formatLength:"short",fullYear:!0},z={formatLength:"short"};u.mixin(E,
{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(r,v){var l=[];null==r||r instanceof Date||(r=new Date(r));v=v||{};v=u.mixin({},v);var h=v.selector?v.selector.toLowerCase():null,D=!h||-1<h.indexOf("time"),h=!h||-1<h.indexOf("date");D&&(v.timeOptions=v.timeOptions||z,v.timeOptions&&(v.timeOptions=u.mixin({},v.timeOptions),v.timeOptions.selector=v.timeOptions.selector||"time",l.push(v.timeOptions)));h&&(v.dateOptions=v.dateOptions||d,v.dateOptions&&
(v.dateOptions=u.mixin({},v.dateOptions),v.dateOptions.selector=v.dateOptions.selector||"date",l.push(v.dateOptions)));l&&l.length?(l=y.map(l,function(d){return f.format(r,d)}),v=1==l.length?l[0]:k["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(d,f){return l[f]})):v=f.format(r);return v},createColorStops:function(d){var f=d.values,r=d.colors,l=d.labelIndexes,h=d.isDate,k=d.dateFormatOptions;d=[];return d=y.map(f,function(d,v){var D=null;if(!l||-1<y.indexOf(l,v)){var p;(p=
h?E.formatDate(d,k):x.format(d))&&(D=U(p,v,f.length-1))}return{value:d,color:r[v],label:D}})},updateColorStops:function(d){var f=d.stops,l=d.changes,r=d.isDate,h=d.dateFormatOptions,k=[],p,u=y.map(f,function(d){return d.value});y.forEach(l,function(d){k.push(d.index);u[d.index]=d.value});p=x.round(u,{indexes:k});y.forEach(f,function(d,v){d.value=u[v];if(null!=d.label){var l,k=null;(l=r?E.formatDate(p[v],h):x.format(p[v]))&&(k=U(l,v,f.length-1));d.label=k}})},createClassBreakLabel:function(d){var f=
d.minValue,l=d.maxValue,r=d.isFirstBreak?"":H.gt+" ";d="percent-of-total"===d.normalizationType?H.pct:"";f=null==f?"":x.format(f);l=null==l?"":x.format(l);return r+f+d+" \u2013 "+l+d},setLabelsForClassBreaks:function(d){var f=d.classBreaks,l=d.classificationMethod,r=d.normalizationType,h=[];f&&f.length&&("standard-deviation"===l?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):d.round?(h.push(f[0].minValue),y.forEach(f,function(d){h.push(d.maxValue)}),
h=x.round(h),y.forEach(f,function(d,f){d.label=E.createClassBreakLabel({minValue:0===f?h[0]:h[f],maxValue:h[f+1],isFirstBreak:0===f,normalizationType:r})})):y.forEach(f,function(d,f){d.label=E.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===f,normalizationType:r})}))},updateClassBreak:function(d){var f=d.classBreaks,l=d.normalizationType,h=d.change,r=h.index,h=h.value,k=-1,p=-1,u=f.length;"standard-deviation"===d.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):
(0===r?k=r:r===u?p=r-1:(p=r-1,k=r),-1<k&&k<u&&(d=f[k],d.minValue=h,d.label=E.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===k,normalizationType:l})),-1<p&&p<u&&(d=f[p],d.maxValue=h,d.label=E.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===p,normalizationType:l})))},calculateDateFormatInterval:function(d){var f,l,h=d.length,k,r,p,u,z,A,B=Infinity,x;d=y.map(d,function(d){return new Date(d)});for(f=0;f<h-1;f++){k=d[f];p=[];z=Infinity;A=
"";for(l=f+1;l<h;l++)r=d[l],r=k.getFullYear()!==r.getFullYear()&&"year"||k.getMonth()!==r.getMonth()&&"month"||k.getDate()!==r.getDate()&&"day"||k.getHours()!==r.getHours()&&"hour"||k.getMinutes()!==r.getMinutes()&&"minute"||k.getSeconds()!==r.getSeconds()&&"second"||"millisecond",u=Q[r],u<z&&(z=u,A=r),p.push(r);z<B&&(B=z,x=A)}return x},createUniqueValueLabel:function(d){var f=d.value,l=d.fieldInfo,h=d.domain;d=d.dateFormatInterval;var k=String(f);(h=h&&h.codedValues?h.getName(f):null)?k=h:"number"===
typeof f&&(k=l&&"esriFieldTypeDate"===l.type?E.formatDate(f,d&&A[d]):x.format(f));return k},cloneColorInfo:function(d){var f;d&&(f=u.mixin({},d),f.colors=h(f.colors),f.stops=f.stops&&y.map(f.stops,function(d){d=u.mixin({},d);d.color&&(d.color=new B(d.color));return d}),f.legendOptions&&(f.legendOptions=u.mixin({},f.legendOptions)));return f},cloneOpacityInfo:function(d){var f;if(d){f=u.mixin({},d);if(d=f.opacityValues)f.opacityValues=d.slice(0);if(d=f.stops)f.stops=y.map(d,function(d){return u.mixin({},
d)});if(d=f.legendOptions)f.legendOptions=u.mixin({},d)}return f},cloneSizeInfo:function(d){var f;d&&(f=u.mixin({},d),f.stops&&(f.stops=y.map(f.stops,function(d){return u.mixin({},d)})),(d=f.minSize)&&"object"===typeof d&&(f.minSize=E.cloneSizeInfo(d)),(d=f.maxSize)&&"object"===typeof d&&(f.maxSize=E.cloneSizeInfo(d)),d=f.legendOptions)&&(f.legendOptions=u.mixin({},d),d=d.customValues)&&(f.legendOptions.customValues=d.slice(0));return f},getClassCodesForRelationship:function(){return u.clone({2:["L",
"H"],3:["L","M","H"],4:["L","M1","M2","H"]})},getClassValuesForRelationship:function(){return u.clone({2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]})}});l("extend-esri")&&u.setObject("renderer.utils",E,p);return E})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/utils ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(u,
y,l,f,p,x,B,k,h,U,E,H,Q,A,d,z,r,v,R,I,D,ca,X,V,L,F,S,ka,la,ma,na,oa,pa,Y,qa,da,M,W,Z,ea,N,fa,ga,aa){var ha=S.getClassValuesForRelationship(),ia={defaultShape:{type:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15"},stroke:{width:1,color:"#555555"}},ba={HH:315,HL:45,LL:135,LH:225},ja=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,G=y([ga,v],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new B([64,
64,64]),defaultText:"Aa",sizeRampLightColor:new B([255,255,255]),sizeRampDarkColor:new B([128,128,128]),gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,_preserveCacheOnDestroy:!1,_layerConnects:null,_mapConnects:null,constructor:function(a,b){l.mixin(this,aa.widgets.legend);this._i18n=aa.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?
!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this._preserveCacheOnDestroy=a.preserveCacheOnDestroy?!0:!1,this.arrangement=a.arrangement===G.ALIGN_RIGHT?G.ALIGN_RIGHT:G.ALIGN_LEFT,this.arrangement===G.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=k(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},
postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,c;for(b=0;b<a.length;b+=1)c=a[b],u.locale&&-1!==u.locale.indexOf(c)&&(-1!==u.locale.indexOf("-")?-1!==u.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},
startup:function(){this.inherited(arguments);this._initialize();9>h("ie")&&(this._repaintItems=l.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeCachedLegendResponses();this._removeHoverHandlers();this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||f.forEach(this.layers,function(a){delete a.legendResponse})},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=
[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=
this.domNode.children.length-1;0<=a;a--)d.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):
this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];f.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);var e;this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));"esri.layers.KMLLayer"==c.declaredClass&&
(e=c.getLayers(),f.forEach(e,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==c.declaredClass&&(e=c.getFeatureLayers(),f.forEach(e,function(a){b.push(a.id)},this))},this);f.forEach(this.map.graphicsLayerIds,function(c){var e=this.map.getLayer(c);-1==f.indexOf(a,c)&&-1==f.indexOf(b,c)&&this._isSupportedLayerType(e)&&this._isLayerDrawingEnabled(e)&&(e.arcgisProps&&e.arcgisProps.title&&(e._titleForLegend=e.arcgisProps.title),this.layers.push(e))},this)}this._createLegend()},_isLayerDrawingEnabled:function(a){return a&&
(a._params&&a._params.drawMode||a.isFeatureReductionActive&&a.isFeatureReductionActive())},_activate:function(){this._deactivate();if(this.autoUpdate){this._mapConnects=[];this._layerConnects={};var a=this._mapConnects;this._respectCurrentMapScale&&a.push(p.connect(this.map,"onZoomEnd",this,"_refreshLayers"));this.useAllMapLayers&&(a.push(p.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers")),a.push(p.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers")),a.push(p.connect(this.map,"onLayersReordered",
this,"_updateAllMapLayers")));f.forEach(this.layers,function(a){var b=[p.connect(a,"onFeatureReductionRendererChange",this,"_refreshLayers"),p.connect(a,"onFeatureReductionChange",this,"_refreshLayers"),p.connect(a,"onVisibilityChange",this,"_refreshLayers"),p.connect(a,"onOpacityChange",this,"_refreshLayers"),p.connect(a,"onScaleRangeChange",this,"_refreshLayers")];"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&b.push(p.connect(a,"_onDynamicLayersChange",l.hitch(this,
"_updateDynamicLayers",a)));if("esri.layers.ArcGISImageServiceLayer"===a.declaredClass||"esri.layers.RasterXLayer"===a.declaredClass)b.push(p.connect(a,"onRenderingChange",l.partial(this._updateImageServiceLayers,this,a))),b.push(p.connect(a,"onRendererChange",l.partial(this._updateImageServiceLayers,this,a)));("esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||a.setWebGLEnabled)&&b.push(p.connect(a,"onRendererChange",l.hitch(this,"_refreshLayers")));this._layerConnects[a.id]=b},this)}},
_deactivate:function(){f.forEach(this._mapConnects,function(a){p.disconnect(a)});f.forEach(this.layers,function(a){var b=this._layerConnects;b&&f.forEach(b[a.id],function(a){p.disconnect(a)})},this);this._mapConnects=this._layerConnects=null},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];f.forEach(this.map.layerIds,
function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);f.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this._isLayerDrawingEnabled(a)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,b=!1;z.set(this.domNode,"position","relative");d.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var c=[];f.forEach(this.layers,function(g){if("esri.layers.KMLLayer"==
g.declaredClass||"esri.layers.GeoRSSLayer"==g.declaredClass){var e;g.loaded?("esri.layers.KMLLayer"==g.declaredClass?e=g.getLayers():"esri.layers.GeoRSSLayer"==g.declaredClass&&(e=g.getFeatureLayers(),this.hideLayersInLegend[g.id]&&(e=f.filter(e,function(a){return-1==f.indexOf(this.hideLayersInLegend[g.id],a.id)},this))),f.forEach(e,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&g._titleForLegend&&(a._titleForLegend=g._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=
this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_areas),c.push(a))},this)):p.connect(g,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===g.declaredClass)if(!g.loaded)p.connect(g,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}));else{if((!this._respectVisibility||this._respectVisibility&&g.visible)&&0<g.layerInfos.length&&f.some(g.layerInfos,
function(a){return a.legendURL})){var n=!1;f.forEach(g.layerInfos,function(b){if(b.legendURL&&-1<f.indexOf(g.visibleLayers,b.name)){n||(d.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(g._titleForLegend||g.name||g.id)+"\x3c/span\x3e"},this.domNode),n=!0);var c;b=b.legendURL;if(g.customParameters||g.customLayerParameters){var e=l.clone(g.customParameters||{});l.mixin(e,g.customLayerParameters||{});for(c in e)b+=(-1===b.indexOf("?")?"?":"\x26")+c+"\x3d"+e[c]}d.create("div",
{innerHTML:"\x3cimg src\x3d'"+b+"'/\x3e"},this.domNode);a=!0}},this)}}else"esri.layers.WFSLayer"!==g.declaredClass||g.renderer?c.push(g):(e=d.create("div",{id:this.id+"_"+g.id,"class":"esriLegendService"}),d.create("span",{innerHTML:this._getServiceTitle(g),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},e))))),d.place(e,this.id,"first"),e=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
e),e=d.create("tbody",{},e),"esriGeometryComplex"===g.geometryType?(this._buildRow_Renderer(g,g._pointSymbol,null,this.NLS_points,null,e),this._buildRow_Renderer(g,g._lineSymbol,null,this.NLS_lines,null,e),this._buildRow_Renderer(g,g._polygonSymbol,null,this.NLS_areas,null,e)):"esriGeometryPoint"===g.geometryType?this._buildRow_Renderer(g,g._pointSymbol,null,"",null,e):"esriGeometryPolyline"===g.geometryType?this._buildRow_Renderer(g,g._lineSymbol,null,"",null,e):"esriGeometryPolygon"===g.geometryType&&
this._buildRow_Renderer(g,g._polygonSymbol,null,"",null,e),b=!0)},this);var e=[];f.forEach(c,function(a){if(!a.loaded)var b=p.connect(a,"onLoad",this,function(a){p.disconnect(b);b=null;this.refresh()});else if((!this._respectVisibility||this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass||"esri.layers.RasterXLayer"==a.declaredClass)){var c=d.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});d.create("span",
{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},c)))));d.place(c,this.id,"first");a.legendResponse||a.renderer&&"esri.renderer.StretchRenderer"!==a.renderer.declaredClass||a.renderer&&"esri.renderer.StretchRenderer"===a.renderer.declaredClass&&1===a.bandCount?this._createLegendForLayer(a):this.isHostedTileService(a)?this._getLayerInfos(a).then(l.hitch(this,function(a){this._createLegendForLayer(a)}),
l.hitch(this,function(a){e.push(this._legendRequest(a))})):"esri.layers.RasterXLayer"===a.declaredClass&&-1<a.capabilities.toLowerCase().indexOf("tilesonly")?this._createLegendForTileOnlyService(a):e.push(this._legendRequest(a))}},this);0!==e.length||a||b?(new H(e)).addCallback(l.hitch(this,function(c){a||b?A.byId(this.id+"_msg").innerHTML="":A.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()})):(A.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForTileOnlyService:function(a){function b(b,
e){var d=["red","green","blue"],q=[[255,0,0],[0,255,0],[0,0,255]];(e&&e.length>=f?c(e):c()).forEach(function(c,e){var f=new M(M.STYLE_SQUARE,20,new W(W.STYLE_SOLID,new B([0,0,0]),1),new B(q[e]));b._buildRow_Renderer(a,f,null,d[e]+": "+c,null,g)},b)}function c(b){var c=(a.bandIds&&a.bandIds.length?a.bandIds:[0,1,2]).map(function(a){return b&&b[a]&&b[a].BandName||"Band_"+(a+1)});3>c.length?c.push(c[1]):3<c.length&&c.splice(3);return c}var e=d.create("div",{id:this.id+"_"+a.id+"_clientLegend","class":"esriLegendServiceLabel"},
A.byId(this.id+"_"+a.id));d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},e))));var e=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e),g=d.create("tbody",{},e),f=a.bandCount;if(1<f)a.getKeyProperties().then(l.hitch(this,function(a){b(this,a.BandProperties)}),l.hitch(this,function(a){b(this)})),z.set(A.byId(this.id+"_"+a.id),"display","block"),z.set(A.byId(this.id+"_msg"),"display",
"none");else{var e={colorRamp:{type:"algorithmic",fromColor:[0,0,0],toColor:[255,255,255]}},n=a.renderer,C,t;n&&n.statistics&&n.statistics.length?(C=null!=n.statistics[0].min?n.statistics[0].min:n.statistics[0][0],t=null!=n.statistics[0].max?n.statistics[0].max:n.statistics[0][1]):(C=a.serviceInfo.minValues.length?a.serviceInfo.minValues[0]:0,t=a.serviceInfo.maxValues.length?a.serviceInfo.maxValues[0]:255);this._createStretchLegend(g,n||e,C,t)}},_createLegendForLayer:function(a){if(a.legendResponse||
a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)f.forEach(c,function(c,g){this.hideLayersInLegend[a.id]&&-1!==f.indexOf(this.hideLayersInLegend[a.id],c.id)||(c=this._buildLegendItems(a,c,g),b=b||c)},this);else if("esri.layers.ArcGISImageServiceLayer"==a.declaredClass||"esri.layers.RasterXLayer"==a.declaredClass)b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},
0)}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(z.set(A.byId(this.id+"_"+a.id),"display","block"),z.set(A.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);p.connect(a,"onLoad",l.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,c=
b.indexOf("?"),b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var e=l.hitch(this,"_processLegendResponse"),g={f:"json"};a._params.dynamicLayers&&(g.dynamicLayers=Q.stringify(this._createDynamicLayers(a)),"[{}]"===g.dynamicLayers&&(g.dynamicLayers="[]"));a._params.bandIds&&(g.bandIds=a._params.bandIds);a._params.renderingRule?g.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&f.forEach(a.rasterFunctionInfos,
function(a){a&&a.name&&"none"===a.name.toLowerCase()&&(g.renderingRule=Q.stringify({rasterFunction:a.name}))});return V({url:b,content:g,callbackParamName:"callback",load:function(b,c){e(a,b,c)},error:X.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length),b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!h("ie")||8<h("ie"))b+="\x26returnbytes\x3dtrue";var c=l.hitch(this,"_processLegendResponse");
return V({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,g){c(a,b,g)},error:X.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,A.byId(this.id+"_"+a.id)&&d.empty(A.byId(this.id+"_"+a.id)),d.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},A.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):
console.log("Legend could not get generated for "+a.url+": "+x.toJson(b))},_buildLegendItems:function(a,b,c){var e=!1,g=A.byId(this.id+"_"+a.id),q=b.parentLayerId;if(b.subLayerIds)a=d.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==q?0<c?"esriLegendGroupLayer":"":this._legendAlign},-1==q?g:A.byId(this.id+"_"+a.id+"_"+q+"_group")),d.create("td",{innerHTML:D.encode(b.name),align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},
a))));else{if(this._respectVisibility&&a.visibleLayers)if(c=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===f.indexOf(a.visibleLayers,b.id))return e}else{if(c=this._getReallyVisibleLayers(c,a.visibleLayers),-1===f.indexOf(c,b.id))return e}else if(-1===f.indexOf(a.visibleLayers,b.id))return e;g=d.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<q?this._legendAlign:""},-1==q?g:A.byId(this.id+"_"+a.id+"_"+q+"_group"));d.create("td",{innerHTML:D.encode(b.name)||
"",align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},g))));c=a.dynamicLayerInfos||a.layerInfos;q=!1;c&&c.length&&(q=f.some(c,function(a){return!!a.drawingInfo}));if(a.legendResponse)e=e||this._buildLegendItems_Tools(a,b,g);else if(a.renderer||q)e=e||this._buildLegendItems_Renderer(a,b,g)}return e},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var c=[],e=[],g;for(g=0;g<a.length;g++)if(a[g].subLayerIds){if(-1===
f.indexOf(b,a[g].id)||-1<f.indexOf(e,a[g].id))e=e.concat(a[g].subLayerIds)}else-1<f.indexOf(b,a[g].id)&&-1===f.indexOf(e,a[g].id)&&c.push(a[g].id);return c},_buildLegendItems_Tools:function(a,b,c){var e=b.parentLayerId,g=this.map.getScale(),q=!1,n=function(a,b){var c,e;for(c=0;c<a.length;c++)if(b.dynamicLayerInfos)for(e=0;e<b.dynamicLayerInfos[e].length;e++){if(b.dynamicLayerInfos[e].mapLayerId==a[c].layerId)return a[c]}else if(b.id==a[c].layerId)return a[c];return{}};if(!this._respectCurrentMapScale||
this._respectCurrentMapScale&&this._isLayerInScale(a,b,g)){var C=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var t=this._getEffectiveScale(a,b);if(t.minScale&&t.minScale<g||t.maxScale&&t.maxScale>g)C=!1}if(C){var g=n(a.legendResponse.layers,b),w=g.legendType,m=g.layerType,l=g.legend;if(l){"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&"esri.layers.RasterXLayer"===a.declaredClass||
this._sanitizeLegendResponse(a,g,b);c=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var h=d.create("tbody",{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);var k=[];f.forEach(l,function(c){if(!(10.1<=a.version&&!c.values&&1<l.length)||!a._hideDefaultSymbol&&"\x3call other values\x3e"!==c.label&&(c.label||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version||"Raster Layer"===m)){var e=c.label;if(c.url&&0===c.url.indexOf("http")||
c.imageData&&0<c.imageData.length)q=!0,e&&-1!==f.indexOf(k,e)||(k.push(e),this._buildRow_Tools(c,h,a,b.id,w))}},this)}}}q&&(z.set(A.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(z.set(A.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,a,e)));return q},_getLayerInfos:function(a){var b=new E,c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)if(f.some(c,function(a){return!!a.drawingInfo}))b.resolve(a);else{var e=a.url,g=e.indexOf("?"),e=-1==g?e+"/layers":
e.substring(0,g)+"/layers"+e.substring(g,e.length);V({url:e,content:{f:"json"},callbackParamName:"callback",load:function(e,g){e.layers?(f.forEach(c,function(a){var b=f.filter(e.layers,function(b){return a.source?b.id===a.source.mapLayerId:b.id===a.id});b&&b[0]&&b[0].drawingInfo&&(a.drawingInfo=b[0].drawingInfo,a.fields=b[0].fields)}),b.resolve(a)):b.reject(a)},error:function(c){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,c){var e=b.legend;if(10.1<=a.version&&1<e.length&&!b._sanitized){a=
l.getObject("layerDefinition.drawingInfo.renderer",!1,c);var g,d;a||(a=l.getObject("drawingInfo.renderer",!1,c));f.some(e,function(a){if(a.values)return!0})&&f.some(e,function(a,b){a.values||(d=b,g=a);return!!g});a?"uniqueValue"===a.type?g&&(e.splice(d,1),e.push(g)):"classBreaks"===a.type&&(g&&e.splice(d,1),e.reverse(),g&&e.push(g)):g&&(e.splice(d,1),e.push(g));b._sanitized=!0}},_buildRow_Tools:function(a,b,c,e,g){var f=d.create("tr",{},b),n;this.alignRight?(b=d.create("td",{align:this._isRightToLeft?
"left":"right"},f),n=d.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(n=d.create("td",{width:35,align:"center"},f),b=d.create("td",{},f));f=a.url;(!h("ie")||9<=h("ie")||9>h("ie")&&("esri.layers.ArcGISImageServiceLayer"===c.declaredClass||"esri.layers.RasterXLayer"===c.declaredClass))&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+e+"/images/"+a.url,(e=c._getToken())&&(f+="?token\x3d"+e));e=d.create("img",{src:f,
border:0,style:"opacity:"+c.opacity},n);a=d.create("td",{innerHTML:D.encode(a.label),align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%",dir:"ltr"},b))));g&&"Stretched"===g&&10.3<=c.version&&("esri.layers.ArcGISImageServiceLayer"===c.declaredClass||"esri.layers.RasterXLayer"===c.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",b.style.verticalAlign="top");9>h("ie")&&(e.style.filter="alpha(opacity\x3d"+
100*c.opacity+")")},_getVariable:function(a,b,c){var e;a&&(e=(a=a.getVisualVariablesForType(b,c))&&a[0]);return e},_getVariables:function(a,b,c){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?f.filter(a,function(a){return!(!a||a.field!==b||a.normalizationField!=c)}):a},_getFieldAlias:function(a,b,c){var e=b.infoTemplate||(b.infoTemplates&&c&&b.infoTemplates[c.id]?b.infoTemplates[c.id].infoTemplate:null),e=e&&e.getFieldInfo&&
e.getFieldInfo(a);a=l.isFunction(a)?null:this.getField(b,a,c);b=e||a;c="";b&&(c=e&&e.label||a&&a.alias||b.name||b.fieldName);return c},_getDomainName:function(a,b,c,e){var g;a&&!l.isFunction(a)&&(g=(c=(a=this.getField(c,a,e))&&c.getDomain?c.getDomain(a.name):null)&&c.codedValues?c.getName(b):null);return g},_getRampTitle:function(a,b,c){var e,g=a.field,d=a.normalizationField,f=!1,C=!1,t=!1,g=l.isFunction(g)?null:g,d=l.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)e=a.legendOptions.title;
else if(a.valueExpressionTitle)e=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var w=b.renderer.authoringInfo.visualVariables;for(a=0;a<w.length;a++){var m=w[a];if("colorInfo"===m.type&&"ratio"===m.style){f=!0;break}else if("colorInfo"===m.type&&"percent"===m.style){C=!0;break}else if("colorInfo"===m.type&&"percentTotal"===m.style){t=!0;break}}}(f=t&&"showRatioPercentTotal"||C&&"showRatioPercent"||f&&"showRatio"||d&&"showNormField"||
g&&"showField"||null)&&(e=L.substitute({field:g&&this._getFieldAlias(g,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===f?"${field}":this._i18n[f]))}return e},_getRendererTitle:function(a,b,c){var e;if(a){var g,d,f;"esri.renderer.ClassBreaksRenderer"===a.declaredClass&&(g=a.attributeField,d=a.normalizationField,f="percent-of-total"===a.normalizationType);g=l.isFunction(g)?null:g;d=l.isFunction(d)?null:d;a.legendOptions&&a.legendOptions.title?e=a.legendOptions.title:a.valueExpressionTitle?
e=a.valueExpressionTitle:(a=d&&"showNormField"||(f?"showNormPct":null)||g&&"showField"||null)&&(e=L.substitute({field:g&&this._getFieldAlias(g,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===a?"${field}":this._i18n[a]))}return e},_buildLegendItems_Renderer:function(a,b,c){function e(){z.set(A.byId(T.id+"_"+a.id+"_"+b.id),"display","block");-1<g&&(z.set(A.byId(T.id+"_"+a.id+"_"+g+"_group"),"display","block"),this._findParentGroup(a.id,g))}var g=b.parentLayerId,q=this.map,n=q.getScale(),
C,t=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,n)){var w,m,h,k,p,u,v;m="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:b&&b.drawingInfo?fa.fromJson(l.clone(b.drawingInfo.renderer)):a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionRenderer():a.renderer;if("esri.renderer.ScaleDependentRenderer"===m.declaredClass&&(m=(q="zoom"===m.rangeType?m.getRendererInfoByZoom(q.getZoom()):m.getRendererInfoByScale(n))&&q.renderer,!m))return!1;
q=m&&m.authoringInfo&&"relationship"===m.authoringInfo.type;if("esri.renderer.StretchRenderer"!==m.declaredClass&&"esri.renderer.ShadedReliefRenderer"!==m.declaredClass){var r=this._getVariables(m),y=f.filter(r,function(a){return!!a}).length,x=r[0],J=r[1],r=r[2],E,F,G,H,O;x&&(h=this._getMedianColor(m,x),x.field&&(p=l.isFunction(x.field)?null:this.getField(a,x.field,b)),E=!(x.legendOptions&&!1===x.legendOptions.showLegend));J&&(J.field&&(v=l.isFunction(J.field)?null:this.getField(a,J.field,b)),F=!(J.legendOptions&&
!1===J.legendOptions.showLegend));r&&(r.field&&(u=l.isFunction(r.field)?null:this.getField(a,r.field,b)),G=!(r.legendOptions&&!1===r.legendOptions.showLegend))}if("esri.renderer.HeatmapRenderer"===m.declaredClass)C=t=!0,this._showHeatRamp(a,b,m,c);else if("esri.renderer.DotDensityRenderer"===m.declaredClass)C=t=!0,this._showDotDensityLegend(a,b,m,c);else if("esri.renderer.TemporalRenderer"===m.declaredClass)C=t=!0,n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
c),w=d.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b),m.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===m.latestObservationRenderer.declaredClass&&this._buildRow_Renderer(a,m.latestObservationRenderer.symbol,h,D.encode(m.latestObservationRenderer.label)||this.NLS_currentObservations,null,w),m.observationRenderer&&"esri.renderer.SimpleRenderer"===m.observationRenderer.declaredClass&&this._buildRow_Renderer(a,m.observationRenderer.symbol,h,D.encode(m.observationRenderer.label)||
this.NLS_previousObservations,null,w);else if("esri.renderer.UniqueValueRenderer"===m.declaredClass){if(m.infos&&0<m.infos.length){C=t=!0;if(m.legendOptions&&m.legendOptions.title||m.valueExpressionTitle)n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=d.create("tbody",{},n),y=m.legendOptions&&m.legendOptions.title?m.legendOptions.title:m.valueExpressionTitle,this._buildRow_Renderer(a,null,h,D.encode(y),null,w);n=d.create("table",{cellpadding:0,cellspacing:0,
width:"95%","class":"esriLegendLayer"},c);w=d.create("tbody",{},n);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b);m.attributeField&&r&&this._addSubHeader(w,this._getFieldAlias(m.attributeField,a,b));if(q){var K=m.authoringInfo;O=K.focus;var y=K.numClasses,I=K.field1.field,n=K.field2.field;if(y&&I&&n){var P=K.field1.normalizationField,K=K.field2.normalizationField,R=P&&this._i18n.showNormField||I&&"${field}",S=K&&this._i18n.showNormField||n&&"${field}",I=L.substitute({field:this._getFieldAlias(I,
a,b),normField:P&&this._getFieldAlias(P,a,b)},R),n=L.substitute({field:this._getFieldAlias(n,a,b),normField:K&&this._getFieldAlias(K,a,b)},S),P={shapeDescriptor:ia,rotation:this._getRotationAngleForFocus(O)||0};this._buildRow_Renderer(a,null,null,D.encode(I),null,w,null,P);P.rotation+=90;this._buildRow_Renderer(a,null,null,D.encode(n),null,w,null,P);this._drawRelationshipLegend(c,{numClasses:y,focus:O,uvInfos:m.infos})}}else{var Q=[];f.forEach(m.infos,function(c){var e=null;this._isLayerEditable(a)&&
a.types&&(e=this._getTemplateFromTypes(a.types,c.value));var g=c.label;null==g&&(g=this._getDomainName(m.attributeField,c.value,a,b)||c.value);-1===f.indexOf(Q,g)&&(Q.push(g),this._buildRow_Renderer(a,c.symbol,h,D.encode(g),e,w))},this)}}O=!q&&this._displayDefaultSymbol(a,m,c)}else if("esri.renderer.ClassBreaksRenderer"===m.declaredClass){if(m.infos&&0<m.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass)C=t=!0,H=this._isUnclassedRenderer(m),x||1!==m.infos.length||(k=(k=m.infos[0])&&
k.symbol),H||(n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=d.create("tbody",{},n),y=this._getRendererTitle(m,a,b),this._buildRow_Renderer(a,null,h,D.encode(y),null,w)),n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=d.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b),H&&r&&G||(q=m.infos.slice(0).reverse(),f.forEach(q,function(b){var c=b.label;null!=c||H||(c=b.minValue+" - "+
b.maxValue);this._buildRow_Renderer(a,b.symbol,h,D.encode(c),null,w)},this)),"esri.layers.ArcGISImageServiceVectorLayer"!==a.declaredClass||a.renderer.style!==Y.STYLE_SCALAR&&a.renderer.style!==Y.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(a,m.defaultSymbol,null,"",null,w),a._hideDefaultSymbol=!0);H||(O=this._displayDefaultSymbol(a,m,c))}else if("esri.renderer.StretchRenderer"===m.declaredClass){C=t=!0;n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},c);w=d.create("tbody",
{},n);var T=this,M,N;if(a.renderingRule)a.getRenderingRuleServiceInfo(a.renderingRule).then(function(b){var c=b&&b.minValues&&0<b.minValues.length&&b.maxValues&&0<b.maxValues.length;b&&1<b.bandCount||!c?T._legendRequest(a).then(function(b){T._processLegendResponse(a,b)}):(m.statistics.length?(M=m.statistics[0][1],N=m.statistics[0][0]):(N=b.minValues[0],M=b.maxValues[0]),T._createStretchLegend(w,m,N,M))});else{q=a.serviceInfo;if("esri.layers.RasterXLayer"===a.declaredClass&&(q=a.raster.serviceInfo,
a.hasMultidimensions))return a.getVariableStats(a.mosaicRule&&a.mosaicRule.multidimensionalDefinition?a.mosaicRule.multidimensionalDefinition[0].variableName:a._defaultMultidimensionalDefinition[0].variableName).then(l.hitch(this,function(a){this._createStretchLegend(w,m,a[0].min,a[0].max);e()})),t;this._createStretchLegend(w,m,q?q.minValues[0]:a.minValues[0],q?q.maxValues[0]:a.maxValues[0])}}else"esri.renderer.ShadedReliefRenderer"===m.declaredClass?(C=t=!0,n=d.create("table",{cellpadding:0,cellspacing:0,
width:"95%",class:"esriLegendLayer"},c),w=d.create("tbody",{},n),this._createStretchLegend(w,m,0,255)):"esri.renderer.SimpleRenderer"===m.declaredClass?(C=t=!0,n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=d.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b),k=null,this._isLayerEditable(a)&&a.templates&&0<a.templates.length&&(k=a.templates[0]),q=1<y?null:p&&E||v&&F||u&&G,this._buildRow_Renderer(a,m.symbol,h,D.encode(q?
this._getRampTitle(1<y?null:x||J||r,a,b):m.label),k,w),k=x?null:m.symbol,q&&(p=v=u=null)):"esri.renderer.ColormapRenderer"===m.declaredClass&&(m.colormapInfos&&m.colormapInfos.length&&(C=t=!0),n=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=d.create("tbody",{},n),m.colormapInfos.forEach(function(b){var c=new Z(Z.STYLE_SOLID,null,new B(b.color));this._buildRow_Renderer(a,c,null,b.label,null,w)},this),a._hideDefaultSymbol=!0);C&&(x&&E&&(x.field||x.valueExpression)&&
this._showGradientRamp(a,b,m,null,c,x,p,null,r&&G?!0:!1),r&&G&&(r.field||r.valueExpression&&!ja.test(r.valueExpression))&&(C=x&&E||"esri.renderer.UniqueValueRenderer"===m.declaredClass?!1:!0,this._showSizeLegend(a,b,m,r,h,c,u,null,C)),J&&F&&(J.field||J.valueExpression)&&this._showGradientRamp(a,b,m,k&&!k.url&&k.color?k.color:this.transparencyRampColor,c,J,v,null,!1));O||H&&!E&&!G&&!F||(O=this._displayDefaultSymbol(a,m,c));t=t||O}T=this;t&&e();return t},_createStretchLegend:function(a,b,c,e){var g=
d.create("tr",{},a),f;f=d.create("td",{rowspan:2,"class":"esriStretchLegend"},g);b=d.toDom(this._addColorRamp(b.colorRamp));d.place(b,f);d.create("td",{},g).innerHTML=this._i18n.high+": "+Math.round(e*Math.pow(10,3))/Math.pow(10,3);a=d.create("tr",{},a);d.create("td",{},a).innerHTML=this._i18n.low+": "+Math.round(c*Math.pow(10,3))/Math.pow(10,3)},_addColorRamp:function(a){a||(a={algorithm:"hsv",fromColor:[0,0,0,1],toColor:[255,255,255,1]});var b=this._generateColorRampDivs(a);a.label="\x3cdiv class\x3d'esriStretchLegendGradientLabel'\x3e"+
b+"\x3c/div\x3e";return a.label},_generateColorRampDivs:function(a){if(a){var b,c="";if("multipart"===a.type){b=100/a.colorRamps.length;var e=a.colorRamps;Object.keys(e).reverse().forEach(function(a){c+=this._generateSingleGradientDiv(e[a].fromColor,e[a].toColor,b)},this)}else c=this._generateSingleGradientDiv(a.fromColor,a.toColor,100);return c}},_generateSingleGradientDiv:function(a,b,c){if(a&&b){var e,g="";a=a.toRgb?a.toRgb():a;b=b.toRgb?b.toRgb():b;e="(0deg, rgb("+a.slice(0,3).join()+"), rgb("+
b.slice(0,3).join()+"));";f.forEach(["-webkit-linear-gradient","-o-linear-gradient","-moz-linear-gradient","linear-gradient"],function(a){g+="background: "+a+e});return"\x3cdiv class\x3d'esriStretchLegendSingleGradient' style\x3d'height:"+c+"%;"+g+"'\x3e\x3c/div\x3e"}},_isLayerEditable:function(a){return"function"===typeof a.isEditable&&a.isEditable()},_isUnclassedRenderer:function(a,b){var c;if("esri.renderer.ClassBreaksRenderer"===a.declaredClass&&a.infos&&1===a.infos.length){c=a.attributeField;
var e=a.normalizationField;c=b?c===b:!!this._getVariables(a,c,e).length}return c},_displayDefaultSymbol:function(a,b,c){var e;!a._hideDefaultSymbol&&b.defaultSymbol&&(e=!0,c=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),c=d.create("tbody",{},c),this._buildRow_Renderer(a,b.defaultSymbol,null,D.encode(b.defaultLabel)||"others",null,c));return e},_showGradientRamp:function(a,b,c,e,g,f,n,C,t){t=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+
(t?"":" esriLegendSubFragment")},g);g=d.create("tbody",{},t);(a._hoverLabel||a._hoverLabels||C)&&this._createHoverAction(t,a,b,C);(n||f.valueExpression||f.legendOptions&&f.legendOptions.title)&&this._addSubHeader(g,this._getRampTitle(f,a,b));n=f.field;var q;n&&(q=l.isFunction(n)?null:this.getField(a,n,b));if(f=(b=this._getRampStops(c,f,e,q&&"esriFieldTypeDate"===q.type))?b.length:0)f=10<f,this._drawGradientRamp(g,b,!f,a,this._getRampBorderColor(c),!!e,f)},_getMedianColor:function(a,b){var c,e;b.colors?
(c=b.minDataValue,e=b.maxDataValue):b.stops&&(c=b.stops[0].value,e=b.stops[b.stops.length-1].value);return a.getColor(c+(e-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c,e){var g,d,n,l,t=!1;b.colors||b.opacityValues?(d=b.maxDataValue-b.minDataValue,g=f.map([0,.25,.5,.75,1],function(a){n=b.minDataValue+a*d;return Number(n.toFixed(6))}),this._checkPrecision(0,4,g)):b.stops&&(g=f.map(b.stops,function(a){return a.value}),(t=f.some(b.stops,function(a){return!!a.label}))&&(l=f.map(b.stops,function(a){return a.label})));
var w=g[0],m,h;d=g[g.length-1]-w;return f.map(g,function(f,n){c?(m=new B(c.toRgba()),h=a.getOpacity(f,{opacityInfo:b}),null!=h&&(m.a=h)):m=a.getColor(f,{colorInfo:b});var q="";if(t)q=l[n];else{var q=e?S.formatDate(f,S.timelineDateFormatOptions):F.format(f),C="";0===n?C=this._specialChars.lt+" ":n===g.length-1&&(C=this._specialChars.gt+" ");q=C+q}return{value:f,color:m,offset:1-(f-w)/d,label:q}},this).reverse()},_checkPrecision:function(a,b,c){var e=a+(b-a)/2,g=c[a],d=c[e],f=c[b],l=Math.floor(g),t=
Math.floor(d),w=Math.floor(f);l===g&&w===f&&t!==d&&l!==t&&w!==t&&(c[e]=t);a+1!==e&&this._checkPrecision(a,e,c);e+1!==b&&this._checkPrecision(e,b,c)},_getRampBorderColor:function(a){var b;if("esri.renderer.SimpleRenderer"===a.declaredClass)b=a.symbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,c,e,g,q,
n){var l=d.create("tr",{},a),t,w,m,k,p,r=b.length-1,u;k=0;this.alignRight?(a=d.create("td",{align:this._isRightToLeft?"left":"right"},l),t=d.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},l)):(t=d.create("td",{width:this.gradientWidth,align:"center"},l),a=d.create("td",{},l));l=g&&0<g.a&&!(240<=g.r&&240<=g.g&&240<=g.b);w=d.create("div",{"class":l?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},t);t=d.create("div",{"class":"esriLegendColorRamp"+
(q?" esriLegendTransparencyRamp":"")},w);q=z.get(t,"width");l&&(g=9>h("ie")?g.toHex():"rgba("+g.toRgba().join(",")+")",z.set(t,"border",this.colorRampBorder+" "+g));c?(g=this.gradientHeight*r,z.set(t,"height",g+"px")):g=z.get(t,"height");z.set(w,"height",g+"px");l=R.createSurface(t,q,g);9>h("ie")&&(k=l.getEventSource(),z.set(k,"position","relative"),z.set(k.parentNode,"position","relative"),k=1);try{c&&f.forEach(b,function(a,b){a.offset=b/r}),p=l.createRect({x:-k,y:-k,width:q+k,height:g+k}),p.setFill({type:"linear",
x1:0,y1:0,x2:0,y2:g,colors:b}).setStroke(null),l.createRect({width:q,height:g}).setFill(new B([255,255,255,1-e.opacity])).setStroke(null),this._surfaceItems.push(l)}catch(sa){l.clear(),l.destroy()}f.forEach(b,function(a,c){a.label&&(u="top:"+100*a.offset+"%;",a="",0===c&&(a+=" esriLegendColorRampTickFirst"),c===b.length-1&&(a+=" esriLegendColorRampTickLast"),d.create("div",{"class":"esriLegendColorRampTick"+a,innerHTML:"\x26nbsp;",style:u},w))});m=d.create("div",{"class":"esriLegendColorRampLabels",
style:{height:g+this.gradientHeight+"px"}},a);c?f.forEach(b,function(a){d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:D.encode(a.label)||"\x26nbsp;"},m)}):(d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:n?D.encode(b[0].label)||"\x26nbsp;":this._i18n.high},m),d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:n?D.encode(b[b.length-1].label)||"\x26nbsp;":this._i18n.low,style:"top: "+(g+this.gradientHeight-2*this.gradientHeight)+"px;"},m))},_showHeatRamp:function(a,
b,c,e,g){var f,n=c.field;f=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);e=d.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||g)&&this._createHoverAction(f,a,b,g);(n=n&&this.getField(a,n,b))&&this._addSubHeader(e,this._getFieldAlias(n.name,a,b));b=this._getHeatmapStops(c);b.length&&this._drawGradientRamp(e,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var c,e,g,d;b&&b[0]?(c=b.length-1,(a=b[0]&&null!=b[0].ratio)?(a=b[c])&&1!==a.ratio&&
(b=b.slice(0),b.push({ratio:1,color:a.color}),c++):(e=b[0].value,g=b[c].value-e,b=f.map(b,function(a){return{color:a.color,ratio:(a.value-e)/g}}))):a&&a[0]&&(c=a.length-1,d=1/(a.length-1),b=f.map(a,function(a,b){return{color:a,ratio:b*d}}));b=f.map(b,function(a,b){var e="";0===b?e="Low":b===c&&(e="High");return{color:a.color,label:e,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,c,e){var g=c.legendOptions,q,n,h,t,w,m,k,p=this.dotDensitySwatchSize,r=Math.round(p/2);g&&(n=
g.backgroundColor,h=g.outline,t=g.valueUnit,w=g.dotCoverage);w=(w||this.dotCoverage)/100;k=Math.round(p*p/Math.pow(c.dotSize,2)*w);e=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);m=d.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,a,b);this._addSubHeader(m,L.substitute({value:c.dotValue,unit:t||""},this.NLS_dotValue));f.forEach(c.fields,function(e){e=l.mixin({},e);e.numPoints=k;q=new da(c._generateImageSrc(p,p,[e],{x:0,y:0},
{x:p,y:p},n),h||c.outline,p,p);e=this.getField(a,e.name,b)||e;this._buildRow_Renderer(a,q,null,D.encode(this._getFieldAlias(e.name,a,b)),null,m,{type:"path",path:"M "+-r+","+-r+" L "+r+","+-r+" L "+r+","+r+" L "+-r+","+r+" L "+-r+","+-r+" E"})},this)},_showSizeLegend:function(a,b,c,e,g,f,n,h,t){var q=e.legendOptions,q=q&&q.customValues;g=this._getSizeSymbol(c,g);if((!e.valueUnit||"unknown"===e.valueUnit)&&g&&(q||null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue||e.stops&&
!(1>=e.stops.length))){t=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(t?"":" esriLegendSubFragment")},f);f=d.create("tbody",{},t);(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(t,a,b,h);(n||e.valueExpression||e.legendOptions&&e.legendOptions.title)&&this._addSubHeader(f,this._getRampTitle(e,a,b));n=(t=(h=e.field)&&!l.isFunction(h))&&"cluster_count"===h.toLowerCase();b=(b=t?a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionField(h):
this.getField(a,h,b):null)&&"esriFieldTypeDate"===b.type;var q=q||this._getDataValues(c,g,e,b,n),m,k=q.length-1;for(h=k;0<=h;h--)t=q[h],g=N.fromJson(g.toJson()),this._applySize(g,c,e,t),t=b?S.formatDate(t,S.timelineDateFormatOptions):F.format(t),m="",h===k?m=this._specialChars.gt+" ":0===h&&(m=n&&1===q[h]?"":this._specialChars.lt+" "),m="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+D.encode(m+t)+"\x3c/span\x3e",this._buildRow_Renderer(a,g,null,m,null,f)}},_getSizeSymbol:function(a,b){var c,e;
if("esri.renderer.SimpleRenderer"===a.declaredClass)c=a.symbol;else if("esri.renderer.VectorFieldRenderer"===a.declaredClass)c=a.defaultSymbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)c=a.infos[0].symbol,e=1<a.infos.length;if(c=c&&-1!==c.type.indexOf("fillsymbol")?null:c)if(c=N.fromJson(c.toJson()),b||e)-1!==c.type.indexOf("linesymbol")?c.setColor(new B(this.sizeRampDarkColor)):(c.setColor(new B(this.sizeRampLightColor)),
c.setOutline&&(a=new W,a.setColor(new B(this.sizeRampDarkColor)),a.setWidth(1.5),c.setOutline(a)));return c},_getDataValues:function(a,b,c,e,g){if(g){var d;f.some([5,3,2],function(g){g=this._getDataValuesByCount(a,b,c,e,g);this._hasFractionalValues(g)||(d=g);return!!d},this);return d}return this._getDataValuesByCount(a,b,c,e,5)},_getDataValuesByCount:function(a,b,c,e,g,d){g=null==g?5:g;d=null==d?20:d;var l=a.getSizeRangeAtScale(c,this.map.getScale());g=this._interpolateSizeRange(l,g);var h=this._getDataRange(c),
q=f.map(g,function(a){return this._getDataValueFromSize(a,h,l)},this);if(!e){var k,q=F.round(q);for(e=1;e<q.length-1;e++)if(k=this._roundDataValue(a,b,c,q[e],q[e-1],d))q[e]=k[0],g[e]=k[1]}return q},_hasFractionalValues:function(a){return f.some(a,function(a){return a!==Math.floor(a)})},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var c=a.minSize;a=(a.maxSize-c)/(b-1);var e,d=[];
for(e=0;e<b;e++)d.push(c+a*e);return d},_getDataValueFromSize:function(a,b,c){var e=c.minSize;c=c.maxSize;var d=b.min;b=b.max;return a<=e?d:a>=c?b:(a-e)/(c-e)*(b-d)+d},_roundDataValue:function(a,b,c,e,d,f){var g=this._getSize(b,a,c,e);d=this._getSize(b,a,c,d);var l,h=F.getDigits(e),q=h.integer,h=h.fractional,m,k,p,r,u,v,y,z,x,A,B;0<e&&1>e&&(l=Math.pow(10,h),e*=l,q=F.getDigits(e).integer);for(--q;0<=q&&(m=Math.pow(10,q),h=Math.floor(e/m)*m,m*=Math.ceil(e/m),null!=l&&(h/=l,m/=l),k=(h+m)/2,k=F.round([h,
k,m],{indexes:[1]})[1],p=this._getSize(b,a,c,h),r=this._getSize(b,a,c,m),u=this._getSize(b,a,c,k),v=F.getPctChange(g,p,d,null),y=F.getPctChange(g,r,d,null),z=F.getPctChange(g,u,d,null),x=v.prev<=f,A=y.prev<=f,x&&A&&(v.prev<=y.prev?(x=!0,A=!1):(A=!0,x=!1)),x?B=[h,p]:A?B=[m,r]:z.prev<=f&&(B=[k,u]),!B);q--);return B},_applySize:function(a,b,c,e){var d=a.type;b=this._getSize(a,b,c,e);switch(d){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":d=a.width;c=a.height;a.setHeight(b);
a.setWidth(d/c*b);break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,c,e){return b.getSize(e,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,b,c,e,g,f,l,h){var q=!!h,k=d.create("tr",{},f),m;if(this.alignRight){if(f=d.create("td",{align:this._isRightToLeft?"left":"right"},k),b||q)m=d.create("td",{align:this._isRightToLeft?"left":
"right",width:35},k)}else{if(b||q)m=d.create("td",{width:35,align:"center"},k);f=d.create("td",{},k)}var n=k=30,p;if(b)if("simplemarkersymbol"==b.type)k=Math.min(Math.max(k,b.size+12),125),n=Math.min(Math.max(n,b.size+12),125);else if("picturemarkersymbol"==b.type)k=Math.min(Math.max(k,b.width),125),n=Math.min(b.height||n,125);else if("textsymbol"==b.type){var r,u;b.text||(r=b.text,u=!0,b.setText(this.defaultText));k=Math.min(Math.max(k,b.getWidth()+12),125);n=Math.min(Math.max(n,b.getHeight()+12),
125);u&&b.setText(r)}if(b||q)p=d.create("div",{style:"width:"+k+"px;height:"+n+"px;"},m);L.isDefined(e)&&"number"===typeof e&&(e=""+e);d.create("td",{innerHTML:e||"",align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},f))));if(b||q)a=this._drawSymbol(p,b,c,k,n,g,a,l,h),this._surfaceItems.push(a)},_addSubHeader:function(a,b){a=d.create("tr",{},a);a=d.create("td",{align:this._align,colspan:2},a);d.create("td",{innerHTML:D.encode(b)||"",align:this._align},d.create("tr",
{},d.create("tbody",{},d.create("table",{width:"95%"},a))))},_drawSymbol:function(a,b,c,e,d,f,k,p,t){var g=b&&N.fromJson(b.toJson()),m=k.opacity;b=!!t;if(g)if(c&&g.setColor(new B(c.toRgba())),"simplelinesymbol"===g.type||"cartographiclinesymbol"===g.type||"textsymbol"===g.type){if(!g.color)return;c=g.color.toRgba();c[3]*=m;g.color.setColor(c)}else"simplemarkersymbol"===g.type||"simplefillsymbol"===g.type?(g.color&&(c=g.color.toRgba(),c[3]*=m,g.color.setColor(c)),g.outline&&g.outline.color&&(c=g.outline.color.toRgba(),
c[3]*=m,g.outline.color.setColor(c))):"picturemarkersymbol"===g.type&&(a.style.opacity=m,a.style.filter="alpha(opacity\x3d("+100*m+"))");a=R.createSurface(a,e,d);9>h("ie")&&(c=a.getEventSource(),z.set(c,"position","relative"),z.set(c.parentNode,"position","relative"));f=b?t.shapeDescriptor:this._getDrawingToolShape(g,f)||N.getShapeDescriptors(g);var q,m=(c=f.defaultShape)&&"text"===c.type;try{m&&!c.text&&(c.text=this.defaultText),q=a.createShape(p||c).setFill(f.fill).setStroke(f.stroke),m&&q.setFont(f.font)}catch(ra){a.clear();
a.destroy();return}var n=q.getBoundingBox();p=n.width;f=n.height;var m=-(n.x+p/2),r=-(n.y+f/2);c=a.getDimensions();m={dx:m+c.width/2,dy:r+c.height/2};if(g&&"simplemarkersymbol"===g.type&&"path"===g.style)e=k._getScaleMatrix(n,g.size),q.applyTransform(I.scaleAt(e.xx,e.yy,{x:c.width/2,y:c.height/2}));else if(p>e||f>d)k=p/e>f/d,e=((k?e:d)-5)/(k?p:f),l.mixin(m,{xx:e,yy:e});q.applyTransform(m);b&&q.applyTransform(I.rotategAt(t.rotation,p/2,f/2));return a},_getDrawingToolShape:function(a,b){switch(b?b.drawingTool||
null:null){case "esriFeatureEditToolArrow":b={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":b={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":b={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case "esriFeatureEditToolCircle":b={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":b={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:b,
fill:a.getFill(),stroke:a.getStroke()}},_drawRelationshipLegend:function(a,b){var c=b.focus,e=b.numClasses,d=ha[e],f=!!c,h=Math.sqrt(Math.pow(75,2)+Math.pow(75,2)),l={};b.uvInfos.forEach(function(a){l[a.value]={label:a.label,fill:this._getSymbolColor(a.symbol)}},this);b=[];for(var k=0;k<e;k++){for(var p=[],m=0;m<e;m++)p.push(l[d[k][m]].fill);b.push(p)}d=this._getRelationshipCornerLabels(c,l);a=this._drawRampLayout(a,d,h,f);a=R.createSurface(a,h,h);f||(a.rawNode.style.margin="-15px -15px -18px -15px");
b=ea.create2DColorRamp({surface:a,colors:b,numClasses:e,size:75});e=(h-75)/2;h=(h-75)/2;b.applyTransform(I.translate(e,h));f&&b.applyTransform(I.rotategAt(this._getRotationAngleForFocus(c),37.5,37.5));b=a.createGroup();d={width:1,color:"#555555"};k=a.defNode;this._createArrowMarker(k,"start");this._createArrowMarker(k,"end");k=b.createLine({x1:-10,y1:60,x2:-10,y2:15}).setStroke(d);d=b.createLine({x1:15,y1:85,x2:60,y2:85}).setStroke(d);this._setLineArrow(k.rawNode,"left",c);this._setLineArrow(d.rawNode,
"right",c);b.applyTransform(I.translate(e,h));f&&b.applyTransform(I.rotategAt(-45,37.5,37.5));this._surfaceItems.push(a)},_drawRampLayout:function(a,b,c,e){var g=d.create("div",{style:{padding:"10px"}},a);a=c+"px";c+="px";e?(e=d.create("div",{style:{display:"flex"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a,textAlign:"right"},innerHTML:b.left},e),g=d.create("div",{style:{display:"flex",flexDirection:"column",textAlign:"center"}},e),d.create("div",
{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.right},e),e=d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.top},g),e=d.create("div",{style:{height:c,width:c}},g),g=d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.bottom},g)):(g=d.create("div",{style:{display:"table",color:"#555555"}},g),e=d.create("div",{style:{display:"table-row"}},g),c=d.create("div",
{style:{display:"table-row"}},g),g=d.create("div",{style:{display:"table-row"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"bottom"},innerHTML:b.left},e),d.create("div",{style:{display:"table-cell"}},e),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"bottom"},innerHTML:b.top},e),d.create("div",{style:{display:"table-cell"}},c),e=d.create("div",
{style:{display:"table-cell"}},c),d.create("div",{style:{display:"table-cell"}},c),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"top"},innerHTML:b.bottom},g),d.create("div",{style:{display:"table-cell"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"top"},innerHTML:b.right},g));return e},_getSymbolColor:function(a){if(a)return"simplelinesymbol"===
a.type||"simplemarkersymbol"===a.type&&(a.style===M.STYLE_X||a.style===M.STYLE_CROSS)?(a=a.getStroke())&&a.color:a.getFill()},_getRotationAngleForFocus:function(a){var b=ba[a];a&&null==b&&(b=ba.HH);return b},_setLineArrow:function(a,b,c){var e=this.id+"_arrowStart",d=this.id+"_arrowEnd";b="left"===b;switch(c){case "HL":a.setAttribute(b?"marker-start":"marker-end","url(#"+(b?d:e)+")");break;case "LL":a.setAttribute("marker-start","url(#"+d+")");break;case "LH":a.setAttribute(b?"marker-end":"marker-start",
"url(#"+(b?e:d)+")");break;default:a.setAttribute("marker-end","url(#"+e+")")}},_createArrowMarker:function(a,b){var c="start"===b,e=this.id+(c?"_arrowStart":"_arrowEnd");b=c?"0,0 5,5 0,10":"5,0 0,5 5,10";var d=c?5:0,c=document.createElementNS("http://www.w3.org/2000/svg","marker");c.setAttribute("id",e);c.setAttribute("markerWidth","10");c.setAttribute("markerHeight","10");c.setAttribute("refX",d);c.setAttribute("refY","5");c.setAttribute("markerUnits","strokeWidth");c.setAttribute("orient","auto");
e=document.createElementNS("http://www.w3.org/2000/svg","polyline");e.setAttribute("points",b);e.setAttribute("fill","none");e.setAttribute("stroke","#555555");e.setAttribute("stroke-width","1");c.appendChild(e);a.appendChild(c)},_getRelationshipCornerLabels:function(a,b){var c=b.HH.label,e=b.LL.label,d=b.HL.label;b=b.LH.label;switch(a){case "HH":return{top:c,bottom:e,left:d,right:b};case "HL":return{top:d,bottom:b,left:e,right:c};case "LL":return{top:e,bottom:c,left:b,right:d};case "LH":return{top:b,
bottom:d,left:c,right:e};default:return{top:c,bottom:e,left:d,right:b}}},_repaintItems:function(){f.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&l.isArray(a.children)&&f.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,c,e){if(e=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||e)e=D.encode(e),b.mouseMoveHandler=
b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=p.connect(a,"onmousemove",l.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,z.set(A.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(l.hitch(this,function(a,b,c){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,A.byId(this.id+"_hoverLabel")){var e=A.byId(this.id+"_hoverLabel");e.innerHTML="\x3cspan\x3e"+c+"\x3c/span\x3e";z.set(e,"top",
b+"px");z.set(e,"left",a+15+"px");z.set(e,"display","")}else d.create("div",{innerHTML:"\x3cspan\x3e"+c+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},e)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[c.id]=p.connect(a,"onmouseout",l.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,z.set(A.byId(this.id+"_hoverLabel"),"display","none"))}))},
_removeHoverHandlers:function(){var a;f.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)p.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)p.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=[],c;f.forEach(a.dynamicLayerInfos||a.layerInfos,function(d){c={id:d.id};c.source=d.source&&d.source.toJson();var e;a.layerDefinitions&&a.layerDefinitions[d.id]&&(e=a.layerDefinitions[d.id]);e&&(c.definitionExpression=
e);var f;a.layerDrawingOptions&&a.layerDrawingOptions[d.id]&&(f=a.layerDrawingOptions[d.id]);f&&(c.drawingInfo=f.toJson());c.minScale=d.minScale||0;c.maxScale=d.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var d,g=b.dynamicLayerInfos||b.layerInfos;for(d=0;d<g.length;d++)if(c==g[d].id){-1<g[d].parentLayerId&&(z.set(A.byId(this.id+
"_"+a+"_"+g[d].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,g[d].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,d){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,h,k;for(h=0;h<e.length;h++)if(e[h].id===c&&e[h].subLayerIds)for(k=0;k<e[h].subLayerIds.length;k++){var l=e[h].subLayerIds[k];-1===f.indexOf(d,l)&&(d.push(l),b(l,d))}}a.layer.layerInfos&&f.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},
_isLayerInScale:function(a,b,c){var d,f=!0;if(a.legendResponse&&a.legendResponse.layers)for(d=0;d<a.legendResponse.layers.length;d++){var h=a.legendResponse.layers[d];if(b.id==h.layerId){var k,l;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==h.minScale&&a.tileInfo&&(k=a.tileInfo.lods[0].scale),0==h.maxScale&&a.tileInfo&&(l=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(k=Math.min(a.minScale,h.minScale)||a.minScale||h.minScale,l=Math.max(a.maxScale,h.maxScale));if(0<k&&k<c||l>c)f=
!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)f=!1;return f},_getServiceTitle:function(a){var b=a._titleForLegend;b||(b=a.url,a.url?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),
b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],L.isDefined(a)&&(b+=" ("+a+")"));return D.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,d=b.maxScale;if(L.isDefined(b.parentLayerId)){a=a.layerInfos;b=b.parentLayerId;
var f;for(f=a.length-1;0<=f;f--)if(a[f].id==b)if(0==c&&0<a[f].minScale?c=a[f].minScale:0<c&&0==a[f].minScale||0<c&&0<a[f].minScale&&(c=Math.min(c,a[f].minScale)),d=Math.max(d||0,a[f].maxScale||0),-1<a[f].parentLayerId)b=a[f].parentLayerId;else break}return{minScale:c,maxScale:d}},_isSupportedLayerType:function(a){return!(!a||!("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.RasterXLayer"===a.declaredClass||
"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass))},isHostedTileService:function(a){var b=/(https?:)?\/\/services.*\.arcgis\.com/i;
return!("esri.layers.ArcGISTiledMapServiceLayer"!==a.declaredClass||!b.test(a.url))},getField:function(a,b,c){if(a.getField)return a.getField(b);if(c&&c.fields){var d;f.forEach(c.fields,function(a){a.name===b&&(d=a)});return d}return null}});l.mixin(G,{ALIGN_LEFT:0,ALIGN_RIGHT:1});h("extend-esri")&&l.setObject("dijit.Legend",G,ca);return G});